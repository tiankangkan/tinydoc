<!DOCTYPE html>

<html>
<head>
	<meta charset="utf-8">
	<title>Tiny Document</title>
    <script type="text/javascript" src="/jslib/jquery/jquery-2.2.3.min.js"></script>
	<script src="/jslib/ckeditor/ckeditor.js"></script>
    <script src="/jslib/ckeditor/config.js"></script>
    <script src="/apps/editor/js/editor.js"></script>
</head>
<body id="main">
	<div id="editor">
		<h1>Hello world!</h1>
		<p>I'm an instance of <a href="http://ckeditor.com">CKEditor</a>.</p>
	</div>

    <div id="resp">
        <img id="resp_img" src="" style="max-width: 1000px">
    </div>
</body>

<script>
    var url_sync_content = 'sync_content/';
    var doc_editor = initEditor();
    var data = CKEDITOR.instances.editor.getData();
    var last_modify = Date.now() - 5000000;
    var last_char_num = 0;
    var lazy_time_ms = 2000;

    doc_editor.on( 'change', function( evt ) {
        var now = Date.now();
        if (now - last_modify > lazy_time_ms){
            var data = evt.editor.getData();
            last_char_num = data.length;
            last_modify = now;
            handle_editor_change(data);
        }
    });

    function check_change_of_editor(){
        var now = Date.now();
        var data = doc_editor.getData();
        if (data.length != last_char_num && (now - last_modify > lazy_time_ms)){
            last_char_num = data.length;
            last_modify = now;
            handle_editor_change(data);
        }
    }


    function handle_editor_change(data){
        console.log(data);
        $.ajax({
            url: url_sync_content,
            type: "POST",
            data: {
                'editor_content': data,
                'time_stamp': Date.now()
            },
            success: function(data){
                handle_resp_of_change(data);
            }
        })
    }

    function handle_resp_of_change(content){
        $('#resp_img').attr("src", "data:image/jpeg;base64," + content);
    }

    check_change_of_editor();
    setInterval(check_change_of_editor, 5000);

</script>
</html>
